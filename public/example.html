<!doctype html>
<html>
<script src="buffer.js"></script>

<script>
    let Buffer = buffer.Buffer;

    function downloadFile(url, outputPath) {
        return fetch(url)
            .then(x => x.arrayBuffer())
            .then(x => {
                FS.writeFile(outputPath, Buffer.from(x));
            });

    }

    var Module = {

        getFloatArrayFromFunctionCall: function(func_name, size) {
            var res_ptr = Module._malloc(size * 4);
            Module.ccall(func_name, null, ["number"], [res_ptr]);
            var view = Module.HEAPF32.subarray(res_ptr >> 2, (res_ptr >> 2) + size);
            Module._free(res_ptr);
            return view;
        },

        onRuntimeInitialized: function () {
            FS.mkdir('/working');
            FS.mount(MEMFS, { root: '.' }, '/working');
            downloadFile('simple.xml', '/working/simple.xml').then(() => {
                let model = Module.Model.load_from_xml("/working/simple.xml");
                let state = new Module.State(model);

                let simulation = new Module.Simulation(model, state);

                for(let i = 0; i < 7; i++){ //simulation.model().names().size()
                    console.log(simulation.model().names().get(i));
                }

                for (var i = 0; i < 100; i++) {
                    simulation.step();
                    //console.log(simulation.xquat()[0]);
                    console.log(model.mesh_vert().get(0));
                }
            });
        }
    };
</script>
<script src="mujoco_wasm.js"></script>

</html>